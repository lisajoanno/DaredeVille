<!DOCTYPE html>
<html lang="fr" ng-app="daredeville">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>My AngularJS App</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css">
    <link rel="stylesheet" href="assets/css/sandstone.css">
    <style>
      html, body {
        height:100%;
      }
      #map {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>

  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">DareDeVille</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#" onclick="position()">Position des aveugles</a></li>
          <li><a href="#" onclick="dangers()">Dangers</a></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="#">Itineraire</a></li>
              <li><a href="#">Dangers</a></li>
              <li role="separator" class="divider"></li>
              <li><a href="#">Clients disponibles</a></li>
            </ul>
          </li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>

  <div id="map"></div>
  <div ng-view></div>
  <hr>
    <footer>
      <p>&copy; 2016 DareDeVille, Inc.</p>
    </footer>

    <script src="assets/javascript/angular.min.js"></script>
    <script src="assets/javascript/angular-route.min.js"></script>
    <script src="assets/javascript/ui-bootstrap-tpls-2.2.0.min.js"></script>
    <script src="assets/javascript/ui-bootstrap-tpls-2.2.0.min.js"></script>

    <script src="app.js"></script>
    <script src="components/dangers/dangers.js"></script>
    <script src="components/itinerary/itinerary.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTEwE36GOEhTOzvRzRnr0YDNm-kf9C0Ek&callback=initMap">
  </script>
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script>

    var markers = [];
    var map;
    var colors = ["green", "blue", "red", "yellow", "purple"];
    var dataInterval = null;


    var positions = [];
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
          zoom: 13,
          center: {lat: 43.6047592, lng: 7.0639505}
      });
      map.addListener('click', function(event) {
        //{"lng":7.068469519344075,"lat":43.60343090614397,"email":"Lisa","date":1483662491611, "name": "Lisa"}
        positions.push(
                '{"lng":'+event.latLng.lng()+',"lat":'+event.latLng.lat()+',"email":"Matt","date":1483662491611,"name": "Matt"}');

      });
      var markerCluster = new MarkerClusterer(map, markers,
              {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
      position();
    }

    function addMarker(location, title, label) {
      var color = colors[markers.length];
      var marker = new google.maps.Marker({
        position: location,
        title: title,
        label: label,
        map: map,
        animation: google.maps.Animation.DROP,
        icon: "http://maps.google.com/mapfiles/ms/icons/"+color+"-dot.png"
      });

      markers.push(marker);
    }
    var int = 0;

    function updatePosition(location, title, label) {
      var color = colors[markers.length];
      var test = 0;

      for (var i = 0; i < markers.length ; ++i) {
        if (markers[i].title == title) {
          markers[i].setPosition(location);
          return;
        }
      }
      console.log(markers);
      if (test == 0) {
        var marker = new google.maps.Marker({
          position: location,
          title: title,
          label: label,
          map: map,
          animation: google.maps.Animation.DROP,
          icon: "http://maps.google.com/mapfiles/ms/icons/" + color + "-dot.png"
        });

        markers.push(marker);
      }
    }

    function updateDanger(location, title, label) {
      var color = colors[markers.length];
      for (var i = 0; i < markers.length ; ++i) {
        if (markers[i].title === title && markers[i].location === location) {
          return;
        }
      }
      var marker = new google.maps.Marker({
        position: location,
        title: title,
        label: label,
        map: map,
        animation: google.maps.Animation.DROP,
        icon: "http://maps.google.com/mapfiles/ms/icons/"+color+"-dot.png"
      });
      markers.push(marker);
    }



    function setMapOnAll(map) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
      }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
      setMapOnAll(null);
    }

    // Shows any markers currently in the array.
    function showMarkers() {
      setMapOnAll(map);
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
      clearMarkers();
      markers = [];
    }


    function updatePositions() {
      $.get( "/api/v1/position", function( data ) {
        data = data.reverse().slice(0, 5);
        data.forEach(function(location) {
          updatePosition({lat:location.lat, lng:location.lng}, location.email, location.email);
        });
      });
    }
    function position() {
      deleteMarkers();
      clearInterval(dataInterval);
      dataInterval = setInterval(updatePositions, 500);

    }

    function updateDangers() {
      $.get( "/api/v1/dangers", function( data ) {
        data.data.forEach(function(location) {
          updateDanger({lat:location.latitude, lng: location.longitude}, location.name, location.name);
        });
      });
    }

    function dangers() {
      deleteMarkers();
      clearInterval(dataInterval);
      dataInterval = setInterval(updateDangers, 500);

    }


     </script>


  </body>
</html>
